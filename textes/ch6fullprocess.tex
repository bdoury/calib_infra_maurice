% !TEX root = ../calibreport.tex


%================================
\section{Programs for test}
The full process consists of
\begin{enumerate}
\item
 move data from the IDC, using {\tt RUNextractfromDB.m}. The data with Matlab format is saved. This data consists of a structure called {\tt records} with the following items:
 \begin{itemize}
 \item
{\tt data}: sequence of samples,
 \item
{\tt Fs\_Hz}: sampling frequency,
\item
{\tt stime}, {\tt time}: start and end times, 
\item
{\tt station}: I26C1--I26C8 or I26H1--I26H8
\item
{\tt channel}: 'BDF' or 'LKO' or 'LWD' or 'LWS'
 \end{itemize}   
Typically in the following we use BDF on H and C.   The three other channels are only provided on H1. Channel LWD yields  the wind speed measurement. The wind sensor is located at about 2 meters above the infrasonic sensor. The frequency sampling depends on the channel. Typically for infrasound signals, the frequency sampling is $20$ Hz, and for wind features is 1 Hz.
    
\item
 using the filtercharacteristics, saved in {\tt filtercharacteristics.mat} and the directory which contains the data from one of the 8 channels, run the program {\tt estimationwithFB.m}. This program saves the useful elements for a display in a selected directory.
 \item
 to display run the program {\tt displaySUTresponse.m} for the file recorded in the selected directory of the previous item.
\end{enumerate}


%================================
%================================
%================================
\section{Input of the function {\tt fbankanalysis.m}}
\begin{itemize}
\item
signals: an array of size $N\times 2$ where $N$ is a number of samples, the first column is the signal from the SUT channel and the second for the SREF channel,
\item
filter bank settings: see section \ref{sss:filter-bank-settings},
\item
$F_s$: sampling frequency in Hz, typically $20$ Hz,
\item
MSC threshold: threshold for the MSC, typically $0.98$
\end{itemize}

%================================
\subsubsection{Summary of the filter bank settings}

\label{sss:filter-bank-settings}

\begin{center}
{\tiny\verbatiminput{filtercharacteristicsEXAMPLE.m}}
\end{center}

\begin{itemize}
\item
{\tt designname} means that the name of the filter model. The Butterworth model is available in Matlab. 
\item
{\tt Norder} denotes the order of the filter. If 0 there is no filtering. 
\item
{\tt Wlow\_Hz} denotes the low bound in Hz of the filter design,
\item
{\tt Whigh\_Hz} denotes the high bound in Hz of the filter design,
\item
{\tt windowshape} denotes the weighted window. Many windows are available in Matlab. Window is used to do a compromise between the leakage and the bias. Hann's window is commonly used.
\item
{\tt SCPperiod\_sec} denotes the time duration expressed in second of the window used for the spectral estimation,
\item
{\tt overlapDFT} overlapping rate for the spectral estimation,
\item
{\tt overlapSCP} overlapping rate for the different spectral estimates,
\item
{\tt ratioDFT2SCP} is an integer which denotes the ratio between the duration of the spectral estimation window and the duration of the DFT window. 

\end{itemize}

\newpage\clearpage

%================================
\subsubsection{Calculation scheme}
\figscale{figures/synoptic.pdf}{FB analysis}{fig:synoptic}{1}

Let us report to the figure \ref{fig:synoptic}. The DFT buffer contains the data for a duration in accordance with the DFT analysis. Usually this duration is in the inverse of the bandwidth of the filter. The filter bandwidth is log-scaled in the frequency domain. If the SCP time window is $1000$ seconds and the DFT buffer duration is  a fifth i.e. $200$ seconds with an overlap of $50\%$, the number of DFTs  is $9$. In this case the DFTs can be performed each time we progress in the buffer of $100$ seconds. After 5 times the DFT duration, a weighted averaging is performed along the time in each filter bandwidth to obtain the SCPs taking into account the cells whose the MSC is above a given threshold, typically $0.98$. The frequencies inside each bandwidth is uniformly spaced. With the current values of the filter bank, the number of frequency values for the full bandwidth estimation is less than $100$. In the matlab function (see section \ref{chap:toolbox}) the averaging is obtained on two successive days.





The full calculation is based on the 3 following functions
\begin{itemize}
\item 
function {\tt fbank.m}: 
\begin{itemize}
\item
the function inputs are (1) the two signals, on SUT and SREF, (2) the filter characteristics and (3) the frequency sampling.
\item
The filter outputs are the $P\times 2$ output signals.
\end{itemize}
\item  
function {\tt estimSCP.m}: 
\begin{itemize}
\item
the inputs are the $P\times 2$ signals, the frequency response of the SREF, 
the DFT overlap, the SCP overlap, the frequency sampling and the smooth window. 

\item
the outputs are the SCPs which consist of $P$ time-spectral structures, each of them consists of an array of size $K \times T$ where $K$ is the number of frequency dots in the associated frequency band and $T$ the number of SCP time slots during the full duration of the analysis.
\end{itemize}

function {\tt estimSUT.m}: 
\begin{itemize}
\item
the inputs are the SCPs provided by the function {\tt estimSCP.m} and the MSC threshold.

\item
the outputs are the estimations of the ratio, expression \eqref{eq:ratio-sup-bis-exact}, denoted {\tt Rsup} which consists of $P$ structures. Each structure contains many elements. The most important are: 
\begin{itemize}
\item
the module of the ratio averaged on the different SCP time slots in the time frequency cells where the MSC is over the threshold.
It is denoted {\tt Rsup.modcst}, and the associated standard deviation.
\item
 the phase of the ratio averaged on the different SCP time slots in the time frequency cells where the MSC is over the threshold.
It is denoted {\tt Rsup.phasecst}, and the associated standard deviation
\end{itemize}
It is worth to notice that the variables with the indication {\tt tab} are for the different SCP time slots (without averaging) and the variables with the indication {\tt cst} for the values associated to the time frequency cells where the MSC is over the threshold.

\end{itemize}

\end{itemize}



\newpage\clearpage
%================================
\section{Output of the function {\tt fbankanalysis.m}}

\begin{verbatim}
% 1) SUTs: structures P x 1
%         xx.estimRsup: Rsup ratio
%         xx.estimRinf: Rinf ratio
%         xx.allMSCs: allMSCs;
%         xx.Nsupthreshold: count of the number of values over
%                   the threshold
%         xx.Nsupthresholdintheband: counts of the number of values
%                   over the threshold in the filter bandwidth
%         xx.frqsFFT_Hz: cell P x 1, each cell consists of
%                   frequency list in Hz of the DFTs
%         xx.SCP = all spectral components
%         xx.indexinsidefreqband = P x 1, indices of the
%                    frequency bounds of each filter
%                    in the xx.frqsFFT_Hz
% 2) filteredsignals, 
% 3) allfrqsFFT_Hz, cell P x 1, each cell for each bank filter consists of
%             frequency list in Hz of the DFTs
% 4) alltimes_sec: cell  Px 1, each cell consists of the structure
%             yy.FFT:     time list in second of the DFTs
%             yy.SD:      time list in second of the SCPs
%             yy.signals: time list in second of the signals
% 5) filterbank



\end{verbatim}


%================================
\subsubsection{Remark for developper}

It is advised to provide at the output of the FB analysis function, on one hand the response ratios in each of the $P$ frequency bands  with the associated period and on the other the MSC levels greater than the given threeshold. These two elements have the same size. An external function will perform the averaging over a given period of time with the weights as defined in expression \ref{eq:weights}.

It follows that 
\begin{itemize}
\item
 an extra input must be considered to take into account the duration of the averaging. In our code this time is fixed to two consecutive days, i.e. $48$ hours
\item
 an extra output must be considered to provide the MSC levels associated to each spectral component. We only consider the time-frequency cells where the current MSC is above the given threshold.

\end{itemize}

